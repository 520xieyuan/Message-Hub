<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuthè´¦æˆ·ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }
        
        .table tr:hover {
            background: #f8f9fa;
        }
        
        .platform-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .platform-gmail {
            background: #ea4335;
            color: white;
        }
        
        .platform-slack {
            background: #4a154b;
            color: white;
        }
        
        .platform-lark {
            background: #00d4aa;
            color: white;
        }
        
        .status-active {
            color: #27ae60;
            font-weight: 500;
        }
        
        .status-inactive {
            color: #e74c3c;
            font-weight: 500;
        }
        
        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” OAuthè´¦æˆ·ç®¡ç†ä¸­å¿ƒ</h1>
            <p>ç®¡ç†OAuthåº”ç”¨é…ç½®å’Œç”¨æˆ·ä»¤ç‰Œ</p>
        </div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="stat-apps">-</div>
                <div class="stat-label">OAuthåº”ç”¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-tokens">-</div>
                <div class="stat-label">ç”¨æˆ·ä»¤ç‰Œ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-gmail">-</div>
                <div class="stat-label">Gmailè´¦æˆ·</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-slack">-</div>
                <div class="stat-label">Slackè´¦æˆ·</div>
            </div>
        </div>
        
        <!-- OAuthåº”ç”¨é…ç½® -->
        <div class="section">
            <h2>ğŸ“± OAuthåº”ç”¨é…ç½®</h2>
            
            <div id="app-alert"></div>
            
            <form id="oauth-app-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="platform">å¹³å°</label>
                        <select id="platform" required>
                            <option value="">é€‰æ‹©å¹³å°</option>
                            <option value="gmail">Gmail</option>
                            <option value="slack">Slack</option>
                            <option value="lark">Lark</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="app-name">åº”ç”¨åç§°</label>
                        <input type="text" id="app-name" placeholder="ä¾‹å¦‚: å·¥ä½œGmail, ä¸ªäººSlack" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="client-id">å®¢æˆ·ç«¯ID</label>
                        <input type="text" id="client-id" placeholder="è¾“å…¥OAuthå®¢æˆ·ç«¯ID" required>
                    </div>
                    <div class="form-group">
                        <label for="client-secret">å®¢æˆ·ç«¯å¯†é’¥</label>
                        <input type="password" id="client-secret" placeholder="è¾“å…¥OAuthå®¢æˆ·ç«¯å¯†é’¥" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="redirect-uri">é‡å®šå‘URI</label>
                        <input type="url" id="redirect-uri" placeholder="åŠ è½½ä¸­..." required>
                        <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                            ğŸ’¡ æç¤ºï¼šå°†æ ¹æ®å½“å‰è®¿é—®åœ°å€è‡ªåŠ¨ç”Ÿæˆç¤ºä¾‹ã€‚ä½¿ç”¨ ngrok æ—¶ï¼Œè¯·é€šè¿‡ ngrok URL è®¿é—®æ­¤é¡µé¢
                        </small>
                    </div>
                </div>
                
                <button type="submit" class="btn">æ·»åŠ OAuthåº”ç”¨</button>
            </form>
            
            <div id="oauth-apps-table">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
        
        <!-- ç”¨æˆ·ä»¤ç‰Œç®¡ç† -->
        <div class="section">
            <h2>ğŸ‘¤ ç”¨æˆ·ä»¤ç‰Œç®¡ç†</h2>

            <div class="form-group">
                <label for="search-user">æœç´¢è¿‡æ»¤</label>
                <input type="text" id="search-user" placeholder="è¾“å…¥é‚®ç®±æˆ–ç”¨æˆ·æ ‡è¯†ç¬¦è¿›è¡Œè¿‡æ»¤...">
            </div>

            <div id="user-tokens-table">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- LLM é…ç½® -->
        <div class="section">
            <h2>ğŸ¤– LLM æ€»ç»“æœåŠ¡é…ç½®</h2>
            <p style="color: #7f8c8d; margin-bottom: 15px;">é…ç½® AI æ€»ç»“åŠŸèƒ½ä½¿ç”¨çš„å¤§è¯­è¨€æ¨¡å‹æœåŠ¡ï¼Œæ‰€æœ‰ Electron å®¢æˆ·ç«¯å°†ä½¿ç”¨æ­¤é…ç½®ã€‚</p>

            <div id="llm-alert"></div>

            <form id="llm-config-form">
                <div class="form-group">
                    <label>æœåŠ¡ç±»å‹</label>
                    <div style="display: flex; gap: 20px; margin-top: 5px;">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="llm-provider" value="ollama" checked>
                            <span>Ollama (æœ¬åœ°/è¿œç¨‹)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="llm-provider" value="openai">
                            <span>OpenAI å…¼å®¹ (OpenAI/DeepSeek/Moonshotç­‰)</span>
                        </label>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="llm-base-url">æœåŠ¡åœ°å€ (Base URL)</label>
                        <input type="url" id="llm-base-url" placeholder="http://localhost:11434" required>
                        <small style="color: #7f8c8d; display: block; margin-top: 5px;" id="llm-url-hint">
                            Ollama é»˜è®¤: http://localhost:11434
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="llm-model">æ¨¡å‹åç§°</label>
                        <input type="text" id="llm-model" placeholder="qwen2.5:7b" required>
                        <small style="color: #7f8c8d; display: block; margin-top: 5px;" id="llm-model-hint">
                            Ollama ç¤ºä¾‹: qwen2.5:7b, llama3:8b
                        </small>
                    </div>
                </div>

                <div class="form-group" id="llm-api-key-group" style="display: none;">
                    <label for="llm-api-key">API Key</label>
                    <input type="password" id="llm-api-key" placeholder="sk-xxxxxxxxxxxxxxxx">
                    <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                        OpenAI å…¼å®¹æœåŠ¡éœ€è¦ API Keyï¼ŒOllama ä¸éœ€è¦
                    </small>
                </div>

                <details style="margin-bottom: 15px;">
                    <summary style="cursor: pointer; color: #3498db; font-weight: 500;">â–¶ é«˜çº§è®¾ç½®</summary>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 4px; margin-top: 10px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="llm-max-tokens">æœ€å¤§è¾“å‡º Tokens</label>
                                <input type="number" id="llm-max-tokens" value="2048" min="100" max="16384">
                            </div>
                            <div class="form-group">
                                <label for="llm-temperature">Temperature (ç”Ÿæˆæ¸©åº¦)</label>
                                <input type="number" id="llm-temperature" value="0.3" min="0" max="2" step="0.1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="llm-timeout">è¯·æ±‚è¶…æ—¶ (æ¯«ç§’)</label>
                            <input type="number" id="llm-timeout" value="120000" min="10000" max="600000" step="1000">
                            <small style="color: #7f8c8d;">å»ºè®® 60000-180000 (1-3åˆ†é’Ÿ)</small>
                        </div>
                    </div>
                </details>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="llm-enabled" checked>
                        <span>å¯ç”¨ LLM æ€»ç»“åŠŸèƒ½</span>
                    </label>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn" id="llm-test-btn" onclick="testLLMConnection()">ğŸ”— æµ‹è¯•è¿æ¥</button>
                    <button type="submit" class="btn">ğŸ’¾ ä¿å­˜é…ç½®</button>
                </div>
            </form>

            <div id="llm-test-result" style="margin-top: 15px;"></div>
        </div>
    </div>
    
    <script>
        const API_BASE = '';
        
        // å…¨å±€å˜é‡å­˜å‚¨æ‰€æœ‰ä»¤ç‰Œ
        let allTokens = [];
        
        // è·å–æœåŠ¡å™¨åœ°å€ï¼ˆä»å½“å‰é¡µé¢ URLï¼‰
        const serverUrl = `${window.location.protocol}//${window.location.host}`;
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadOAuthApps();
            loadAllUserTokens(); // åŠ è½½æ‰€æœ‰ç”¨æˆ·ä»¤ç‰Œ

            // è®¾ç½®è¡¨å•æäº¤äº‹ä»¶
            document.getElementById('oauth-app-form').addEventListener('submit', handleOAuthAppSubmit);

            // è®¾ç½®å¹³å°é€‰æ‹©äº‹ä»¶ï¼ˆæ›´æ–°å ä½ç¬¦æç¤ºï¼‰
            document.getElementById('platform').addEventListener('change', updateRedirectUriPlaceholder);

            // åˆå§‹åŒ– placeholder
            updateRedirectUriPlaceholder();

            // è®¾ç½®æœç´¢æ¡†å®æ—¶è¿‡æ»¤
            document.getElementById('search-user').addEventListener('input', filterUserTokens);

            // åˆå§‹åŒ– LLM é…ç½®
            initLLMConfig();
        });
        
        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/api/stats`);
                const stats = await response.json();
                
                document.getElementById('stat-apps').textContent = stats.oauth_apps;
                document.getElementById('stat-tokens').textContent = stats.user_tokens;
                document.getElementById('stat-gmail').textContent = stats.by_platform.gmail || 0;
                document.getElementById('stat-slack').textContent = stats.by_platform.slack || 0;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½OAuthåº”ç”¨åˆ—è¡¨
        async function loadOAuthApps() {
            try {
                const response = await fetch(`${API_BASE}/api/oauth-apps`);
                const apps = await response.json();
                
                const tableContainer = document.getElementById('oauth-apps-table');
                
                if (apps.length === 0) {
                    tableContainer.innerHTML = '<div class="empty-state">æš‚æ— OAuthåº”ç”¨é…ç½®</div>';
                    return;
                }
                
                const table = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>åº”ç”¨åç§°</th>
                                <th>å¹³å°</th>
                                <th>å®¢æˆ·ç«¯ID</th>
                                <th>é‡å®šå‘URI</th>
                                <th>çŠ¶æ€</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${apps.map(app => `
                                <tr>
                                    <td><strong>${app.name || 'æœªå‘½å'}</strong></td>
                                    <td><span class="platform-badge platform-${app.platform}">${app.platform}</span></td>
                                    <td><code>${app.client_id}</code></td>
                                    <td><small>${app.redirect_uri}</small></td>
                                    <td><span class="status-${app.is_active ? 'active' : 'inactive'}">${app.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
                                    <td>${new Date(app.created_at).toLocaleString()}</td>
                                    <td>
                                        <button class="btn btn-danger btn-small" onclick="deleteOAuthApp('${app.id}')">åˆ é™¤</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                tableContainer.innerHTML = table;
            } catch (error) {
                console.error('åŠ è½½OAuthåº”ç”¨å¤±è´¥:', error);
                document.getElementById('oauth-apps-table').innerHTML = '<div class="alert alert-error">åŠ è½½å¤±è´¥</div>';
            }
        }
        
        // å¤„ç†OAuthåº”ç”¨è¡¨å•æäº¤
        async function handleOAuthAppSubmit(event) {
            event.preventDefault();
            
            const formData = {
                platform: document.getElementById('platform').value,
                name: document.getElementById('app-name').value,
                client_id: document.getElementById('client-id').value,
                client_secret: document.getElementById('client-secret').value,
                redirect_uri: document.getElementById('redirect-uri').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/api/oauth-apps`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('app-alert', 'success', 'âœ… OAuthåº”ç”¨åˆ›å»ºæˆåŠŸï¼');
                    document.getElementById('oauth-app-form').reset();
                    loadStats();
                    loadOAuthApps();
                    loadAllUserTokens(); // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                } else {
                    showAlert('app-alert', 'error', 'âŒ ' + result.error);
                }
            } catch (error) {
                console.error('åˆ›å»ºOAuthåº”ç”¨å¤±è´¥:', error);
                showAlert('app-alert', 'error', 'âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ›´æ–°é‡å®šå‘URIå ä½ç¬¦ï¼ˆä¸è‡ªåŠ¨å¡«å……å€¼ï¼‰
        function updateRedirectUriPlaceholder() {
            const platform = document.getElementById('platform').value;
            const redirectUriInput = document.getElementById('redirect-uri');
            
            if (platform) {
                redirectUriInput.placeholder = `${serverUrl}/oauth/callback/${platform}`;
            } else {
                redirectUriInput.placeholder = `${serverUrl}/oauth/callback/{platform}`;
            }
        }
        
        // åˆ é™¤OAuthåº”ç”¨
        async function deleteOAuthApp(appId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªOAuthåº”ç”¨å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/oauth-apps/${appId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('app-alert', 'success', 'âœ… OAuthåº”ç”¨åˆ é™¤æˆåŠŸï¼');
                    loadStats();
                    loadOAuthApps();
                    loadAllUserTokens(); // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                } else {
                    const result = await response.json();
                    showAlert('app-alert', 'error', 'âŒ ' + result.error);
                }
            } catch (error) {
                console.error('åˆ é™¤OAuthåº”ç”¨å¤±è´¥:', error);
                showAlert('app-alert', 'error', 'âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }
        
        // åŠ è½½æ‰€æœ‰ç”¨æˆ·ä»¤ç‰Œ
        async function loadAllUserTokens() {
            const tableContainer = document.getElementById('user-tokens-table');
            tableContainer.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/tokens`);
                allTokens = await response.json();
                
                renderUserTokens(allTokens);
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä»¤ç‰Œå¤±è´¥:', error);
                tableContainer.innerHTML = '<div class="alert alert-error">åŠ è½½å¤±è´¥</div>';
            }
        }
        
        // è¿‡æ»¤ç”¨æˆ·ä»¤ç‰Œ
        function filterUserTokens() {
            const searchTerm = document.getElementById('search-user').value.trim().toLowerCase();
            
            if (!searchTerm) {
                renderUserTokens(allTokens);
                return;
            }
            
            const filtered = allTokens.filter(token => 
                token.user_identifier.toLowerCase().includes(searchTerm) ||
                (token.display_name && token.display_name.toLowerCase().includes(searchTerm)) ||
                (token.name && token.name.toLowerCase().includes(searchTerm)) ||
                token.platform.toLowerCase().includes(searchTerm)
            );
            
            renderUserTokens(filtered);
        }
        
        // æ¸²æŸ“ç”¨æˆ·ä»¤ç‰Œè¡¨æ ¼
        function renderUserTokens(tokens) {
            const tableContainer = document.getElementById('user-tokens-table');
            
            if (tokens.length === 0) {
                const searchTerm = document.getElementById('search-user').value.trim();
                if (searchTerm) {
                    tableContainer.innerHTML = '<div class="empty-state">æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·ä»¤ç‰Œ</div>';
                } else {
                    tableContainer.innerHTML = '<div class="empty-state">æš‚æ— ç”¨æˆ·ä»¤ç‰Œ<br><small>åœ¨Electronåº”ç”¨ä¸­æ·»åŠ è´¦æˆ·åä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</small></div>';
                }
                return;
            }
            
            const table = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>å¹³å°</th>
                            <th>OAuthåº”ç”¨</th>
                            <th>ç”¨æˆ·æ ‡è¯†</th>
                            <th>æ˜¾ç¤ºåç§°</th>
                            <th>è¿‡æœŸæ—¶é—´</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tokens.map(token => {
                            const expiresAt = token.expires_at ? new Date(token.expires_at) : null;
                            const isExpired = expiresAt && expiresAt < new Date();
                            const expiresText = expiresAt 
                                ? `${expiresAt.toLocaleString()} ${isExpired ? 'âŒ å·²è¿‡æœŸ' : 'âœ…'}` 
                                : 'æ°¸ä¸è¿‡æœŸ';
                            
                            return `
                                <tr>
                                    <td><span class="platform-badge platform-${token.platform}">${token.platform}</span></td>
                                    <td>${token.app_name || 'æœªå‘½å'}</td>
                                    <td><code>${token.user_identifier}</code></td>
                                    <td>${token.name || token.display_name || '-'}</td>
                                    <td><small>${expiresText}</small></td>
                                    <td><small>${new Date(token.created_at).toLocaleString()}</small></td>
                                    <td>
                                        <button class="btn btn-danger btn-small" onclick="deleteUserToken('${token.id}')">åˆ é™¤</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            tableContainer.innerHTML = table;
        }
        
        // åˆ é™¤ç”¨æˆ·ä»¤ç‰Œ
        async function deleteUserToken(tokenId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·ä»¤ç‰Œå—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/tokens/${tokenId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('âœ… ç”¨æˆ·ä»¤ç‰Œåˆ é™¤æˆåŠŸï¼');
                    loadAllUserTokens(); // é‡æ–°åŠ è½½æ‰€æœ‰ç”¨æˆ·
                    loadStats(); // æ›´æ–°ç»Ÿè®¡
                } else {
                    const result = await response.json();
                    alert('âŒ ' + result.error);
                }
            } catch (error) {
                console.error('åˆ é™¤ç”¨æˆ·ä»¤ç‰Œå¤±è´¥:', error);
                alert('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(containerId, type, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;

            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }

        // ==================== LLM é…ç½®ç›¸å…³ ====================

        // åŠ è½½ LLM é…ç½®
        async function loadLLMConfig() {
            try {
                const response = await fetch(`${API_BASE}/api/llm/config`);
                const result = await response.json();

                if (result.success && result.data) {
                    const config = result.data;

                    // è®¾ç½® provider
                    document.querySelector(`input[name="llm-provider"][value="${config.provider}"]`).checked = true;
                    updateLLMProviderUI();

                    // è®¾ç½®å…¶ä»–å­—æ®µ
                    document.getElementById('llm-base-url').value = config.baseUrl || '';
                    document.getElementById('llm-model').value = config.model || '';
                    document.getElementById('llm-api-key').value = config.apiKey || '';
                    document.getElementById('llm-max-tokens').value = config.maxTokens || 2048;
                    document.getElementById('llm-temperature').value = config.temperature || 0.3;
                    document.getElementById('llm-timeout').value = config.timeout || 120000;
                    document.getElementById('llm-enabled').checked = config.isEnabled;
                }
            } catch (error) {
                console.error('åŠ è½½ LLM é…ç½®å¤±è´¥:', error);
            }
        }

        // æ›´æ–° LLM Provider UI
        function updateLLMProviderUI() {
            const provider = document.querySelector('input[name="llm-provider"]:checked').value;
            const apiKeyGroup = document.getElementById('llm-api-key-group');
            const urlHint = document.getElementById('llm-url-hint');
            const modelHint = document.getElementById('llm-model-hint');

            if (provider === 'ollama') {
                apiKeyGroup.style.display = 'none';
                urlHint.textContent = 'Ollama é»˜è®¤: http://localhost:11434';
                modelHint.textContent = 'Ollama ç¤ºä¾‹: qwen2.5:7b, llama3:8b';
            } else {
                apiKeyGroup.style.display = 'block';
                urlHint.textContent = 'OpenAI: https://api.openai.com | DeepSeek: https://api.deepseek.com';
                modelHint.textContent = 'OpenAI: gpt-4o, gpt-3.5-turbo | DeepSeek: deepseek-chat';
            }
        }

        // ä¿å­˜ LLM é…ç½®
        async function saveLLMConfig(event) {
            event.preventDefault();

            const provider = document.querySelector('input[name="llm-provider"]:checked').value;
            const config = {
                provider,
                baseUrl: document.getElementById('llm-base-url').value,
                apiKey: document.getElementById('llm-api-key').value,
                model: document.getElementById('llm-model').value,
                maxTokens: parseInt(document.getElementById('llm-max-tokens').value),
                temperature: parseFloat(document.getElementById('llm-temperature').value),
                timeout: parseInt(document.getElementById('llm-timeout').value),
                isEnabled: document.getElementById('llm-enabled').checked
            };

            try {
                const response = await fetch(`${API_BASE}/api/llm/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('llm-alert', 'success', 'âœ… LLM é…ç½®ä¿å­˜æˆåŠŸï¼');
                } else {
                    showAlert('llm-alert', 'error', 'âŒ ' + result.error);
                }
            } catch (error) {
                console.error('ä¿å­˜ LLM é…ç½®å¤±è´¥:', error);
                showAlert('llm-alert', 'error', 'âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // æµ‹è¯• LLM è¿æ¥
        async function testLLMConnection() {
            const provider = document.querySelector('input[name="llm-provider"]:checked').value;
            const testData = {
                provider,
                baseUrl: document.getElementById('llm-base-url').value,
                apiKey: document.getElementById('llm-api-key').value,
                model: document.getElementById('llm-model').value
            };

            const resultDiv = document.getElementById('llm-test-result');
            const testBtn = document.getElementById('llm-test-btn');

            testBtn.disabled = true;
            testBtn.textContent = 'â³ æµ‹è¯•ä¸­...';
            resultDiv.innerHTML = '<div class="loading">æ­£åœ¨æµ‹è¯•è¿æ¥...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/llm/test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });

                const result = await response.json();

                if (result.success) {
                    let modelsInfo = '';
                    if (result.availableModels && result.availableModels.length > 0) {
                        modelsInfo = `<br><small>å¯ç”¨æ¨¡å‹: ${result.availableModels.slice(0, 5).join(', ')}${result.availableModels.length > 5 ? '...' : ''}</small>`;
                    }
                    const modelStatus = result.modelExists
                        ? 'âœ… æ¨¡å‹å·²å®‰è£…'
                        : 'âš ï¸ æ¨¡å‹å¯èƒ½æœªå®‰è£…';

                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            âœ… è¿æ¥æˆåŠŸï¼å“åº”æ—¶é—´: ${result.responseTime}ms
                            <br>${modelStatus}
                            ${modelsInfo}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-error">
                            âŒ ${result.error}
                            <br><small>å“åº”æ—¶é—´: ${result.responseTime}ms</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('æµ‹è¯• LLM è¿æ¥å¤±è´¥:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡åœ°å€
                    </div>
                `;
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'ğŸ”— æµ‹è¯•è¿æ¥';
            }
        }

        // åˆå§‹åŒ– LLM é…ç½®è¡¨å•äº‹ä»¶
        function initLLMConfig() {
            // Provider åˆ‡æ¢äº‹ä»¶
            document.querySelectorAll('input[name="llm-provider"]').forEach(radio => {
                radio.addEventListener('change', updateLLMProviderUI);
            });

            // è¡¨å•æäº¤äº‹ä»¶
            document.getElementById('llm-config-form').addEventListener('submit', saveLLMConfig);

            // åŠ è½½ç°æœ‰é…ç½®
            loadLLMConfig();
        }
    </script>
</body>
</html>